<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>The Realms of the Dwarves - Game</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }
    body {
      min-height: 100vh;
      width: 100vw;
      background: url('aiIMAGESforMEYBOOK/A%20rich%20wooden%20background%20.jpg') center center/cover no-repeat;
      font-family: 'Segoe UI', sans-serif;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      justify-content: stretch;
    }
    .game-flex-center {
      flex: 1 1 auto;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding-top: 70px;
      box-sizing: border-box;
    }
    #game-container {
      background: rgba(255,255,255,0.97);
      border-radius: 18px;
      box-shadow: 0 6px 32px rgba(0,0,0,0.18);
      padding: 36px 32px 32px 32px;
      min-width: 980px;
      min-height: 700px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    #game-title {
      text-align: center;
      font-size: 2rem;
      font-weight: bold;
      margin-bottom: 24px;
      color: #5d4037;
    }
    #maze-canvas {
      display: block;
      margin: 0 auto;
      border-radius: 16px;
      box-shadow: 0 2px 16px rgba(0,0,0,0.12);
      background: #e7dac6;
      image-rendering: pixelated;
      image-rendering: -moz-crisp-edges;
      image-rendering: crisp-edges;
    }
    .game-bottom-bar {
      width: 100%;
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 24px;
    }
    #found-counter {
      font-size: 1.2rem;
      color: #5d4037;
      font-weight: bold;
    }
    #restart-btn {
      padding: 10px 28px;
      font-size: 1.1rem;
      border-radius: 8px;
      border: none;
      background: #388e3c;
      color: #fff;
      cursor: pointer;
    }
    #found-books {
      margin-top: 18px;
      display: flex;
      gap: 18px;
    }
    nav {
      width: 100vw;
      position: fixed;
      top: 0;
      left: 0;
      z-index: 100;
      background: rgba(120, 72, 24, 0.75) url('aiIMAGESforMEYBOOK/A%20rich%20wooden%20background%20.jpg') center center/cover no-repeat;
      box-shadow: none;
      display: flex;
      align-items: center;
      height: 70px;
      border-bottom-left-radius: 32px;
      border-bottom-right-radius: 32px;
      overflow: hidden;
      backdrop-filter: blur(2px);
    }
    nav button {
      margin-left: 40px;
      padding: 12px 28px;
      font-size: 1.2rem;
      border-radius: 8px;
      border: none;
      background: rgba(255,255,255,0.7);
      cursor: pointer;
    }
  </style>
</head>
<body>
  <nav>
    <button onclick="window.location.href='index.html'">Home</button>
  </nav>
  <div class="game-flex-center">
    <div id="game-container">
      <div id="game-title">Tal-Tormind Library: Labyrinth Book Hunt</div>
      <canvas id="maze-canvas" width="960" height="640"></canvas>
      <div class="game-bottom-bar">
        <div id="found-counter">Found 0/5 Books</div>
        <button id="restart-btn">Restart</button>
      </div>
      <div id="found-books"></div>
    </div>
  </div>
  <script>
    // Maze settings
    const COLS = 24, ROWS = 16, CELL = 40;
    let maze = [], player = {x:1, y:1}, books = [], found = [], totalBooks = 5;
    const bookImg = new Image();
    bookImg.src = 'aiIMAGESforMEYBOOK/on old dwarven tome no background.jpg';
    const playerColor = '#388e3c';
    let visible = [];
    function generateMaze() {
      maze = Array.from({length:ROWS}, (_,y) =>
        Array.from({length:COLS}, (_,x) =>
          (x===0||y===0||x===COLS-1||y===ROWS-1) ? 1 : ((x%2===0)&&(y%2===0)&&Math.random()>0.2) ? 1 : 0
        )
      );
      maze[1][1]=0; maze[ROWS-2][COLS-2]=0;
      books = [];
      while (books.length < totalBooks) {
        let bx = Math.floor(Math.random()*(COLS-2))+1, by = Math.floor(Math.random()*(ROWS-2))+1;
        if (maze[by][bx]===0 && !(bx===1&&by===1) && !books.some(b=>b.x===bx&&b.y===by)) books.push({x:bx,y:by});
      }
      found = [];
      player = {x:1, y:1};
      visible = Array.from({length:ROWS},()=>Array(COLS).fill(false));
      reveal(player.x, player.y);
    }
    function reveal(x, y) {
      for(let dy=-1;dy<=1;dy++) for(let dx=-1;dx<=1;dx++) {
        let nx=x+dx, ny=y+dy;
        if(nx>=0&&ny>=0&&nx<COLS&&ny<ROWS) visible[ny][nx]=true;
      }
    }
    function drawMaze() {
      const ctx = document.getElementById('maze-canvas').getContext('2d');
      ctx.clearRect(0,0,COLS*CELL,ROWS*CELL);
      // Draw maze tiles
      for(let y=0;y<ROWS;y++) for(let x=0;x<COLS;x++) {
        if(maze[y][x]===1) {
          ctx.fillStyle = '#a07b50';
          ctx.fillRect(x*CELL, y*CELL, CELL, CELL);
          ctx.strokeStyle = '#7c5c3b';
          ctx.lineWidth = 2;
          ctx.strokeRect(x*CELL+1, y*CELL+1, CELL-2, CELL-2);
        } else {
          ctx.fillStyle = '#e7dac6';
          ctx.fillRect(x*CELL, y*CELL, CELL, CELL);
        }
      }
      // Draw books (with glow)
      for(let i=0;i<books.length;i++) {
        let b=books[i];
        if(!found.includes(i) && visible[b.y][b.x]) {
          ctx.save();
          ctx.shadowColor = '#ffe066';
          ctx.shadowBlur = 16;
          ctx.drawImage(bookImg, b.x*CELL+8, b.y*CELL+8, 24, 24);
          ctx.shadowBlur = 0;
          ctx.restore();
        }
      }
      // Draw player (with soft shadow)
      ctx.save();
      ctx.shadowColor = '#222a';
      ctx.shadowBlur = 10;
      ctx.fillStyle = '#5ac6e2';
      ctx.beginPath();
      ctx.arc(player.x*CELL+20, player.y*CELL+20, 14, 0, 2*Math.PI);
      ctx.fill();
      ctx.shadowBlur = 0;
      ctx.restore();
      // Draw soft fog overlay
      for(let y=0;y<ROWS;y++) for(let x=0;x<COLS;x++) {
        if(!visible[y][x]) {
          // Soft fog with blurred edge
          let grad = ctx.createRadialGradient(
            x*CELL+CELL/2, y*CELL+CELL/2, CELL*0.2,
            x*CELL+CELL/2, y*CELL+CELL/2, CELL*0.7
          );
          grad.addColorStop(0, 'rgba(255,255,255,0.55)');
          grad.addColorStop(0.7, 'rgba(255,255,255,0.38)');
          grad.addColorStop(1, 'rgba(255,255,255,0.01)');
          ctx.save();
          ctx.globalAlpha = 0.95;
          ctx.fillStyle = grad;
          ctx.fillRect(x*CELL, y*CELL, CELL, CELL);
          ctx.restore();
        }
      }
    }
    function movePlayer(dx,dy) {
      let nx=player.x+dx, ny=player.y+dy;
      if(maze[ny][nx]===0) {
        player.x=nx; player.y=ny;
        reveal(nx, ny);
        drawMaze();
      }
    }
    function updateCounter() {
      document.getElementById('found-counter').textContent = `Found ${found.length}/${totalBooks} Books`;
    }
    function addFoundBook(idx) {
      const foundBooks = document.getElementById('found-books');
      const img = document.createElement('img');
      img.src = bookImg.src;
      img.alt = 'Book Found';
      img.style.width = '38px';
      img.style.height = '38px';
      img.style.borderRadius = '6px';
      img.style.boxShadow = '0 1px 4px rgba(0,0,0,0.12)';
      foundBooks.appendChild(img);
    }
    function restartGame() {
      generateMaze();
      document.getElementById('found-books').innerHTML = '';
      updateCounter();
      drawMaze();
    }
    document.getElementById('restart-btn').onclick = restartGame;
    document.addEventListener('keydown', e => {
      if(['ArrowUp','w','W'].includes(e.key)) movePlayer(0,-1);
      else if(['ArrowDown','s','S'].includes(e.key)) movePlayer(0,1);
      else if(['ArrowLeft','a','A'].includes(e.key)) movePlayer(-1,0);
      else if(['ArrowRight','d','D'].includes(e.key)) movePlayer(1,0);
    });
    document.getElementById('maze-canvas').addEventListener('click', function(e) {
      const rect = this.getBoundingClientRect();
      const mx = Math.floor((e.clientX-rect.left)/CELL), my = Math.floor((e.clientY-rect.top)/CELL);
      for(let i=0;i<books.length;i++) {
        let b=books[i];
        if(!found.includes(i) && mx===b.x && my===b.y && visible[b.y][b.x]) {
          // Check if X button was clicked (OLED book X button)
          let bx = b.x*CELL+20, by = b.y*CELL+12;
          let dist = Math.sqrt((e.clientX-rect.left-bx)**2 + (e.clientY-rect.top-by)**2);
          if(dist < 10) {
            found.push(i);
            addFoundBook(i);
            updateCounter();
            if(found.length===totalBooks) setTimeout(()=>alert('You found all the books!'),300);
            drawMaze();
            break;
          }
        }
      }
    });
    // Fix: Only start drawing after bookImg is loaded
    bookImg.onload = () => { restartGame(); };
    window.addEventListener('DOMContentLoaded', () => {
      if (bookImg.complete) {
        restartGame();
      }
    });
  </script>
</body>
</html>
